<div class="admin-dashboard">
  <!-- Header Section -->
  <div class="dashboard-header">
    <mat-card class="header-card">
      <mat-card-content>
        <div class="header-content">
          <div class="title-section">
            <h1>Admin Dashboard</h1>
            <p class="week-info">Week of {{ weeklyReport.weekOf | date:'mediumDate' }}</p>
          </div>
          <div class="notification-badge">
            <!-- UPDATED: Using the async pipe for the unread count observable -->
            <button mat-icon-button (click)="toggleNotifications()" class="notification-btn">
              <mat-icon 
                [matBadge]="unreadNotificationsCount$ | async" 
                matBadgeColor="warn" 
                [matBadgeHidden]="(unreadNotificationsCount$ | async) === 0">
                notifications
              </mat-icon>
            </button>
            
            <!-- Notification Dropdown -->
            <div class="notification-dropdown" [class.show]="showNotifications" *ngIf="showNotifications">
              <div class="notification-header">
                <h4>Notifications</h4>
                <button mat-icon-button (click)="toggleNotifications()" class="close-btn">
                  <mat-icon>close</mat-icon>
                </button>
              </div>
              <!-- UPDATED: Using async pipe to unwrap the notifications$ observable -->
              <div class="notification-list" *ngIf="notifications$ | async as notifications">
                <!-- UPDATED: Looping over the unwrapped 'notifications' array -->
                <div *ngFor="let notification of notifications" class="notification-item" [class.unread]="!notification.read">
                  <div class="notification-content">
                    <div class="notification-type">
                      <!-- UPDATED: Using helper functions for dynamic class and text -->
                      <mat-chip [class]="'type-chip ' + getNotificationTypeClass(notification.type)"
                        (click)="redirectToDetails(notification.link)"
                      >
                        {{ formatNotificationType(notification.type) }}
                      </mat-chip>
                    </div>
                    <div class="notification-message">{{ notification.message }}</div>
                    <!-- UPDATED: Using 'createdAt' instead of 'timestamp' -->
                    <div class="notification-time">{{ formatTimestamp(notification.createdAt) }}</div>
                  </div>
                  <div class="notification-actions">
                    <!-- UPDATED: Checking 'notification.read' and passing 'notification._id' -->
                    <button *ngIf="!notification.read" mat-button color="primary" (click)="markAsRead(notification._id)" class="mark-read-btn">
                      Mark as Read
                    </button>
                    <mat-icon *ngIf="notification.read" class="read-icon">check_circle</mat-icon>
                  </div>
                </div>
                <!-- UPDATED: Checking length of the unwrapped 'notifications' array -->
                <div *ngIf="notifications.length === 0" class="no-notifications">
                  <mat-icon>notifications_none</mat-icon>
                  <p>No notifications</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Key Metrics Section (No changes here) -->
  <div class="metrics-section">
    <div class="clinic-selector">
      <mat-form-field appearance="outline">
        <mat-label>Select Clinic</mat-label>
        <mat-select [(value)]="selectedClinic" (selectionChange)="onClinicChange($event.value)">
          <mat-option *ngFor="let clinic of clinics" [value]="clinic._id">
            {{ clinic.name }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>
    <div class="metrics-grid">
      <mat-card class="metric-card">
        <mat-card-content>
          <div class="metric-content">
            <mat-icon class="metric-icon appointments">event</mat-icon>
            <div class="metric-info">
              <h3>{{ weeklyReport.totalAppointments }}</h3>
              <p>Total Appointments</p>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
      <mat-card class="metric-card">
        <mat-card-content>
          <div class="metric-content">
            <mat-icon class="metric-icon records">assignment</mat-icon>
            <div class="metric-info">
              <h3>{{ weeklyReport.patientRecordsChanged }}</h3>
              <p>Records Updated</p>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
      <mat-card class="metric-card">
        <mat-card-content>
          <div class="metric-content">
            <mat-icon class="metric-icon queue">schedule</mat-icon>
            <div class="metric-info">
              <h3>{{ getTodaysQueue().length }}</h3>
              <p>Today's Queue</p>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- Charts Section (No changes here) -->
  <div class="charts-section">
    <div class="charts-grid">
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>Preferred Services Distribution</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container">
            <canvas #servicesChart></canvas>
          </div>
        </mat-card-content>
      </mat-card>
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>Weekly Appointment Trend</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container">
            <canvas #appointmentTrendChart></canvas>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- Data Tables Section -->
  <div class="tables-section">
    <div class="tables-grid">
      <!-- Daily Appointment Queue (No changes here) -->
      <mat-card class="table-card">
        <mat-card-header>
          <mat-card-title>Today's Appointment Queue</mat-card-title>
        </mat-card-header>
        <mat-card-content class="limit-height-card-content">
          <mat-table [dataSource]="appointmentQueue" class="appointment-table">
            <ng-container matColumnDef="time">
              <mat-header-cell *matHeaderCellDef>Time</mat-header-cell>
              <mat-cell *matCellDef="let appointment">
                <mat-icon class="time-icon">access_time</mat-icon>
                {{ appointment.startTime }}
              </mat-cell>
            </ng-container>
            <ng-container matColumnDef="patientName">
              <mat-header-cell *matHeaderCellDef>Patient Name</mat-header-cell>
              <mat-cell *matCellDef="let appointment">
                <mat-icon class="patient-icon">person</mat-icon>
                {{ appointment.patient.firstName }} {{ appointment.patient.lastName }}
              </mat-cell>
            </ng-container>
            <ng-container matColumnDef="service">
              <mat-header-cell *matHeaderCellDef>Service</mat-header-cell>
              <mat-cell *matCellDef="let appointment">
                <div class="services-wrapper">
                  <mat-chip *ngFor="let service of appointment.services" class="service-chip">
                    {{ service.name }}
                  </mat-chip>
                </div>
              </mat-cell>
            </ng-container>
            <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
            <mat-row *matRowDef="let row; columns: displayedColumns;"></mat-row>
          </mat-table>
        </mat-card-content>
      </mat-card>

      <!-- 
        UPDATED: This is the fix for the parser error.
        We use an <ng-container> to safely unwrap the observable.
        The mat-card is now inside this container.
      -->
      <ng-container *ngIf="notifications$ | async as notifications">
        <mat-card class="table-card" *ngIf="!showNotifications">
          <mat-card-header>
            <mat-card-title>Recent Notifications</mat-card-title>
          </mat-card-header>
          <mat-card-content class="limit-height-card-content">
            <!-- UPDATED: dataSource now binds to the 'notifications' variable from the ng-container -->
             <!-- get back here -->
            <mat-table [dataSource]="notifications" class="notifications-table">
              <ng-container matColumnDef="type">
                <mat-header-cell *matHeaderCellDef>Type</mat-header-cell>
                <mat-cell *matCellDef="let notification">
                  <mat-chip
                    [class]="'type-chip ' + getNotificationTypeClass(notification.type)"
                    (click)="redirectToDetails(notification.link)"
                  >
                    {{ formatNotificationType(notification.type) }}
                  </mat-chip>
                </mat-cell>
              </ng-container>

              <ng-container matColumnDef="message">
                <mat-header-cell *matHeaderCellDef>Message</mat-header-cell>
                <mat-cell *matCellDef="let notification">{{ notification.message }}</mat-cell>
              </ng-container>

              <ng-container matColumnDef="timestamp">
                <mat-header-cell *matHeaderCellDef>Date</mat-header-cell>
                <!-- UPDATED: Using 'createdAt' -->
                <mat-cell *matCellDef="let notification">{{ formatTimestamp(notification.createdAt) }}</mat-cell>
              </ng-container>

              <ng-container matColumnDef="status">
                <mat-header-cell *matHeaderCellDef>Status</mat-header-cell>
                <mat-cell *matCellDef="let notification">
                  <!-- UPDATED: Checking 'read' and passing '_id' -->
                  <button *ngIf="!notification.read" mat-button color="primary" (click)="markAsRead(notification._id)" class="mark-read-btn">
                    Mark as Read
                  </button>
                  <mat-icon *ngIf="notification.read" class="read-icon">check_circle</mat-icon>
                </mat-cell>
              </ng-container>

              <mat-header-row *matHeaderRowDef="notificationColumns"></mat-header-row>
              <!-- UPDATED: Row class is bound to 'row.read' -->
              <mat-row *matRowDef="let row; columns: notificationColumns;" [class.unread-row]="!row.read"></mat-row>
            </mat-table>
          </mat-card-content>
        </mat-card>
      </ng-container>

    </div>
  </div>
</div>